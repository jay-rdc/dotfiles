#!/bin/bash

if ! command -v tmux &> /dev/null; then
    echo "Error: 'tmux' is not installed."
    exit 1
fi

if ! command -v fd &> /dev/null; then
    echo "Error: 'fd' is not installed."
    exit 1
fi

if ! command -v fzf &> /dev/null; then
    echo "Error: 'fzf' is not installed."
    exit 1
fi

SELECTED_PATH=$(fd . $HOME -Htd --exclude=".git/" --exclude="node_modules/" | fzf)

if [[ -z "$SELECTED_PATH" ]]; then
    exit 0
fi

# strip trailing slash for setting cwd in tmux
SELECTED_PATH=${SELECTED_PATH%/}

# replace dots with underscores for safety
SESSION_NAME=$(basename "$SELECTED_PATH" | tr . _)

if ! tmux has-session -t="$SESSION_NAME" 2> /dev/null; then
    tmux new-session -ds "$SESSION_NAME" -c "$SELECTED_PATH"
fi

if [[ -n "$TMUX" ]]; then
    tmux switch-client -t "$SESSION_NAME"
else
    tmux attach-session -t "$SESSION_NAME"
fi
